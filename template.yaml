AWSTemplateFormatVersion: "2010-09-09"
Description: "VPN Gateway Template for Site-to-Site VPN"

Parameters:
  VPCId:
    Type: String
    Description: "The VPC ID to which the VGW will attach"

  SubnetId:
    Type: String
    Description: "The subnet ID to which the route table will attach"

  CustomerGatewayIP:
    Type: String
    Description: "The IP address of the Customer Gateway (Azure VPN Gateway)"
    Default: "1.1.1.1"

  PrivateSubnetCIDR:
    Type: String
    Description: "The CIDR block of the private subnet where the EC2 instance resides"
    Default: "192.168.1.0/24"

  Environment:
    Type: String
    Description: The environment name (e.g., development, production)
    AllowedValues:
      - development
      - production
      - default

Resources:
  # Create a VPN Gateway (VGW)
  VGW:
    Type: AWS::EC2::VPNGateway
    Properties:
      Type: "ipsec.1"
      AmazonSideAsn: 10

  # Attach VGW to VPC
  VGWAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref VPCId
      VpnGatewayId: !Ref VGW

  # Define the Customer Gateway (Azure VPN Gateway)
  CustomerGateway:
    Type: AWS::EC2::CustomerGateway
    Properties:
      IpAddress: !Ref CustomerGatewayIP
      Type: "ipsec.1"
      BgpAsn: 20
      Tags:
        - Key: Name 
          Value: !Sub 'AzureVPN_${Environment}'

  # Create the VPN connection between the VGW and Customer Gateway
  VPNConnection:
    Type: AWS::EC2::VPNConnection
    Properties:
      CustomerGatewayId: !Ref CustomerGateway
      Type: "ipsec.1"
      VpnGatewayId: !Ref VGW
      StaticRoutesOnly: false
      Tags:
        - Key: Name
          Value: !Sub 'S2SVPN_${Environment}'

  VPNConnectionRoute:
    Type: AWS::EC2::VPNConnectionRoute
    Properties:
      DestinationCidrBlock: !Ref PrivateSubnetCIDR
      VpnConnectionId: !Ref VPNConnection

  # Create a Route Table for the Subnet
  RouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPCId
      Tags:
        - Key: Name
          Value: !Sub 'RouteTable_${Environment}'

  # Add a Route to the VPN Gateway
  RouteToVGW:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref RouteTable
      DestinationCidrBlock: '0.0.0.0/0'
      GatewayId: !Ref VGW

  # Associate Route Table to the EC2 Subnet
  SubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref SubnetId
      RouteTableId: !Ref RouteTable

Outputs:
  VGWId:
    Description: "The ID of the created VPN Gateway"
    Value: !Ref VGW

  VpnConnectionId:
    Description: "The ID od the VPN Connection"
    Value: !Ref VPNConnection